!function(w){w.fn.ganttView=function(){var e=Array.prototype.slice.call(arguments);1===e.length&&"object"==typeof e[0]&&function(e){var t=this,a=w.extend(!0,{highlightWeekends:!0,highlightToday:!0,toggleableProjects:!0,cellWidth:20,slideWidth:400,kineticScroll:!0,startDate:!1,endDate:!1,startToday:!1,behavior:{clickable:!1,draggable:!0,resizable:!0}},e);a.data?i():a.dataUrl&&w.getJSON(a.dataUrl,function(e){a.data=e,i()});function i(){var e=Math.floor(a.slideWidth/a.cellWidth+5),e=m.getBoundaryDatesFromData(a.data,e);a.start=a.startDate?moment(a.startDate,"MM/DD/YYYY")._d:e[0],a.end=a.endDate?moment(a.endDate,"MM/DD/YYYY")._d:e[1],t.each(function(){var e=w(this),t=w("<div>",{class:"ganttview"});new n(t,a).render(),e.append(t);w("div.ganttview-vtheader",e).outerWidth(),w("div.ganttview-slide-container",e).outerWidth();new s(e,a).apply()})}}.call(this,e[0]),2===e.length&&"string"==typeof e[0]&&function(e,t){{var a;"setSlideWidth"===e&&(a=$("div.ganttview",this)).each(function(){var e=$("div.ganttview-vtheader",a).outerWidth();$(a).width(e+t+1),$("div.ganttview-slide-container",this).width(t)})}}.call(this,e[0],e[1])};var n=function(n,s){function p(e,t,a){t={parent:t.name};w.extend(t,a),e.data("block-data",t)}return{render:function(){!function(e,t){for(var a=w("<div>",{class:"ganttview-vtheader"}),i=0;i<t.length;i++){var n=w("<div>",{class:"ganttview-vtheader-group"});n.append(w("<div>",{class:"ganttview-vtheader-group-name",id:"groupId_"+i}).append(t[i].name).append("<span/>"));for(var s=w("<div>",{class:"ganttview-vtheader-series"}),d=0;d<t[i].series.length;d++){var r=w("<div>",{class:"ganttview-vtheader-series-row"});if(t[i].series[d].sub_series){var o=w("<div>",{class:"series-content"}),l=w("<div>",{class:"series-dates"}),c=w("<div>",{class:"series-users"});o.append('<div class="series-name">'+t[i].series[d].name+"</div>");for(var v=0;v<t[i].series[d].sub_series.length;v++){var g,h,p,m=0<v?'<span class="date-sep">|</span>':"",u=t[i].series[d].sub_series[v];u.user_avatar&&(g=w("<div>",{class:"series-user"}),h=u.user_name,p=u.user_avatar,g.append('<span><img src="'+p+'" alt="'+h+'" title="'+h+'"/></span>'),c.append(g),r.append(c)),l.append(function(){return m+"<span data-event-id='"+t[i].series[d].sub_series[v].id+"'>"+moment(u.start,"MM/DD/YYYY").format("D MMM")+" - "+moment(u.end,"MM/DD/YYYY").format("D MMM")+"</span>"}),o.append(l),r.append(o)}}else r.append(function(){return(t[i].series[d].user_avatar?"<div class='series-user'><span><img src='"+t[i].series[d].user_avatar+"' alt='"+t[i].series[d].user_name+"' title='"+t[i].series[d].user_name+"'/></span></div>":"")+"<div class='series-content'><div class=\"series-name\">"+t[i].series[d].name+"</div><div class='series-dates'><span data-event-id='"+t[i].series[d].id+"'>"+moment(t[i].series[d].start,"MM/DD/YYYY").format("D MMM")+" - "+moment(t[i].series[d].end,"MM/DD/YYYY").format("D MMM")+"</span></div></div>"});s.append(r)}n.append(s),a.append(n)}e.append(a)}(n,s.data);var t,e,a=w("<div>",{class:"ganttview-slide-container"}),i=function(e,t){var a=[];a[e.getFullYear()]=[],a[e.getFullYear()][e.getMonth()]=[e];var i=e;for(;moment(t).isAfter(i);){var n=moment(i).add(1,"days")._d;a[n.getFullYear()]||(a[n.getFullYear()]=[]),a[n.getFullYear()][n.getMonth()]||(a[n.getFullYear()][n.getMonth()]=[]),a[n.getFullYear()][n.getMonth()].push(n),i=n}return a}(s.start,s.end);!function(e,t,a,i,n,s){var d,r=w("<div>",{class:"ganttview-hzheader"}),o=w("<div>",{class:"ganttview-hzheader-months"}),l=w("<div>",{class:"ganttview-hzheader-days"}),c=0;for(d in t)for(var v in t[d]){var g,h=t[d][v].length*a;for(g in c+=h,o.append(w("<div>",{class:"ganttview-hzheader-month",css:{width:h-1+"px"}}).append(moment(parseInt(v)+1,"M").format("MMMM")+" "+d)),t[d][v]){var p=w("<div>",{class:"ganttview-hzheader-day"});m.isWeekend(t[d][v][g])&&i&&p.addClass("ganttview-weekend"),moment(t[d][v][g]).isSame(Date.now(),"day")&&n&&p.addClass("ganttview-today"),moment(t[d][v][g]).isSame(Date.now(),"day")&&s&&p.addClass("ganttview-startToday"),l.append(p.append(t[d][v][g].getDate()))}}o.css("width",c+"px"),l.css("width",c+"px"),r.append(o).append(l),e.append(r)}(a,i,s.cellWidth,s.highlightWeekends,s.highlightToday,s.startToday),function(e,t,a,i,n,s){var d,r=w("<div>",{class:"ganttview-grid"}),o=w("<div>",{class:"ganttview-grid-row"});for(d in a)for(var l in a[d])for(var c in a[d][l]){var v=w("<div>",{class:"ganttview-grid-row-cell"});m.isWeekend(a[d][l][c])&&n&&v.addClass("ganttview-weekend"),moment(a[d][l][c]).isSame(Date.now(),"day")&&s&&v.addClass("ganttview-today"),o.append(v)}i=w("div.ganttview-grid-row-cell",o).length*i,o.css("width",i+"px"),r.css("width",i+"px");for(var g=0;g<t.length;g++){r.append(w("<div>",{class:"ganttview-grid-spacer","data-click-target":"groupId_"+g}));for(var h=0;h<t[g].series.length;h++)r.append(o.clone().addClass("groupId_"+g))}e.append(r)}(a,s.data,i,s.cellWidth,s.highlightWeekends,s.highlightToday),function(e,t){for(var a=w("<div>",{class:"ganttview-blocks"}),i=0;i<t.length;i++){a.append(w("<div>",{class:"ganttview-block-spacer"}));for(var n=0;n<t[i].series.length;n++)a.append(w("<div>",{class:"ganttview-block-container groupId_"+i}))}e.append(a)}(a,s.data),function(e,s,d,r){for(var o=w("div.ganttview-blocks div.ganttview-block-container",e),l=0,c=0;c<s.length;c++)for(var v,g,t,a,i,n,h=0;h<s[c].series.length;h++)s[c].series[h].sub_series?(v=s[c].series[h].sub_series,g=s[c].series[h].name.replace(/(<([^>]+)>)/gi," "),$.each(v,function(e,t){var a=m.daysBetween(t.start,t.end)+1,i=m.daysBetween(r,t.start),n=t.user_name?" ("+t.user_name+")":"",i=w("<div>",{class:"ganttview-block",title:g+n,"data-id":t.id,id:"ganttview-item-"+t.id,css:{width:a*d-7+"px",left:i*d+3+"px"}});p(i,s[c],v[e]),t.color&&i.css("background-color",t.color);e=t.title?t.link?'<a href="'+t.link+'" title="'+t.link+'">'+t.title+"</a>":t.title:m.humanizeOutput(moment(t.start,"MM/DD/YYYY"),moment(t.end,"MM/DD/YYYY"));t.link?i.append(w("<div>",{class:"ganttview-block-text"}).html(e)):i.append(w("<div>",{class:"ganttview-block-text"}).text(e)),w(o[l]).append(i)})):(t=s[c].series[h],a=t.name.replace(/(<([^>]+)>)/gi," "),i=m.daysBetween(t.start,t.end)+1,n=m.daysBetween(r,t.start),p(i=w("<div>",{class:"ganttview-block",title:a,id:"ganttview-item-"+s[c].series[h].id,css:{width:i*d-7+"px",left:n*d+3+"px"}}),s[c],t),s[c].series[h].color&&i.css("background-color",s[c].series[h].color),n=t.title?t.link?'<a href="'+t.link+'" title="'+t.link+'">'+t.title+"</a>":t.title:m.humanizeOutput(moment(t.start,"MM/DD/YYYY"),moment(t.end,"MM/DD/YYYY")),t.link?i.append(w("<div>",{class:"ganttview-block-text"}).html(n)):i.append(w("<div>",{class:"ganttview-block-text"}).text(n)),w(o[l]).append(i)),l++;w(".ganttview-blocks").css({width:$(e).width()})}(a,s.data,s.cellWidth,s.start),n.append(a),w(n).find(".ganttview-blocks").width(a.find(".ganttview-grid").width()),i=n.parent(),w("div.ganttview-grid-row div.ganttview-grid-row-cell:last-child",i).addClass("last"),w("div.ganttview-hzheader-days div.ganttview-hzheader-day:last-child",i).addClass("last"),w("div.ganttview-hzheader-months div.ganttview-hzheader-month:last-child",i).addClass("last"),s.toggleableProjects&&(e=n,t=[.55,0,.1,1],$("div.ganttview-vtheader-group-name",e).addClass("toggle_enabled").on("click",function(){var e=$(this).attr("id");$(this).hasClass("projectHidden")?($(this).removeClass("projectHidden").next("div").children().velocity("slideDown",{duration:180,easing:t}),$(".ganttview-block-container."+e).show(),$(".ganttview-grid-row."+e).velocity("slideDown",{duration:180,easing:t})):($(this).addClass("projectHidden").next("div").children().velocity("slideUp",{duration:180,easing:t}),$(".ganttview-block-container."+e).hide(),$(".ganttview-grid-row."+e).velocity("slideUp",{duration:180,easing:t}))}),$("div.ganttview-grid-spacer",e).on("click",function(){$("#"+$(this).attr("data-click-target")).click()})),s.kineticScroll&&(e=w("div.ganttview-slide-container",e=n),$(e).kinetic({y:!1,filterTarget:function(e,t){return!($(e).closest(".ganttview-block").length||$(e).closest(".ganttview-grid-spacer").length)}})),s.startToday&&setTimeout(function(){var e=m.daysBetween(s.start,moment()._d);a.scrollLeft(e*s.cellWidth)},100)}}},s=function(c,v){function g(e,t,a,i){var n=w("div.ganttview-slide-container",e),e=n.scrollLeft(),e=t.offset().left-n.offset().left-1+e,e=Math.round(e/a),i=moment(i).add(e,"days");t.data("block-data").start=i;e=t.outerWidth(),a=Math.round(e/a)-1,a=moment(i).add(a,"days");t.data("block-data").end=a,t.data("block-data").title||w("div.ganttview-block-text",t).text(m.humanizeOutput(i,a))}return{apply:function(){var e,t,a,i,n,s,d,r,o,l;v.behavior.clickable&&(e=c,t=v.behavior.onClick,w("div.ganttview-block",e).on("click",function(){t&&t(w(this).data("block-data"))})),v.behavior.resizable&&(a=c,i=v.cellWidth,n=v.start,s=v.behavior.onResize,w("div.ganttview-block",a).resizable({grid:i,handles:"e,w",stop:function(){var e=w(this);g(a,e,i,n);var t=e.data("block-data");a.find("[data-event-id="+t.id+"]").text(moment(t.start).format("D MMM")+" - "+moment(t.end).format("D MMM")),s&&s(e.data("block-data"))}})),v.behavior.draggable&&(d=c,r=v.cellWidth,o=v.start,l=v.behavior.onDrag,w("div.ganttview-block",d).draggable({axis:"x",grid:[r,r],containment:"parent",stop:function(){var e=w(this);g(d,e,r,o);var t=e.data("block-data");d.find("[data-event-id="+t.id+"]").text(moment(t.start).format("D MMM")+" - "+moment(t.end).format("D MMM")),l&&l(e.data("block-data"))}}))}}},m={daysBetween:function(e,t){return e&&t?(e=Date.parse(e),t=Date.parse(t),1901==moment(e)._d.getYear()||8099==moment(t)._d.getYear()?0:moment(t).diff(moment(e),"days")):0},isWeekend:function(e){return e.getDay()%6==0},getBoundaryDatesFromData:function(e,t){var i=new Date,n=new Date,a=[];return e.forEach(function(e){e.series.forEach(function(e){e.sub_series?e.sub_series.forEach(function(e){a.push(e)}):a.push(e)})}),a.forEach(function(e,t){var a=Date.parse(e.start),e=Date.parse(e.end);0===t&&(i=a,n=e),moment(i).isAfter(a)&&(i=a),moment(n).isBefore(e)&&(n=e)}),moment(n).diff(i,"days")<t&&(n=moment(i).add(t,"days")),[moment(i)._d,moment(n)._d]},humanizeOutput:function(e,t){var a=moment.duration(moment(t._d).diff(moment(e._d).subtract("1","day"))),t=a._locale._relativeTime.d,e=a._locale._relativeTime.dd,a=parseInt(a.asDays());return a=1<a?e.replace("%d",a):t}}}(jQuery);